---
title: "London shopping malls"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_float: true
        number_sections: true
        theme: flatly
---

```{r warnings = FALSE, message = FALSE, echo = FALSE}
library (magrittr)
library (osmdata)
library (rjson)
library (sf)

crs_utm_london <- 32630
bbox_coords <- c (-0.510375, 51.286758, 0.334015, 51.691875)

osm_to_sf <- function (bbox, crs, geom_type, key, value)
{
    feat <- opq (bbox = bbox)
    if (missing (value))
    {
        feat %<>% add_osm_feature (key = key)
    } else
        feat %<>% add_osm_feature (key = key, value = value)
    feat %<>% osmdata_sf %>%
        extract2 (geom_type) %>%
        st_as_sf %>%
        st_transform (crs)
    feat
}

malls_500m_gpkg <- "malls_500m.gpkg"
malls_5000m_gpkg <- "malls_5000m.gpkg"
public_transport_station_gpkg <- "public_transport_station.gpkg"
junctions_gpkg <- "junctions.gpkg"
highways_gpkg <- "highways.gpkg"
amenities_gpkg <- "amenity.gpkg"
shops_gpkg <- "shop.gpkg"
dir_out <- "gpkg/"
dir.create (dir_out, showWarnings = FALSE)

place_types <- fromJSON (file = "placeTypes.json")

if (!malls_500m_gpkg %in% dir (dir_out))
{
    malls <- osm_to_sf (bbox = bbox_coords, crs = crs_utm_london, key = "shop",
                        value = "mall", geom_type = "osm_polygons")
    malls_500m <- malls %>% st_buffer (500) %>% st_union %>%
        st_cast ("POLYGON")
    malls_5000m <- malls %>% st_buffer (5000) %>% st_union %>%
        st_cast ("POLYGON")
    st_write (malls_500m, paste0 (dir_out, malls_500m_gpkg))
    st_write (malls_5000m, paste0 (dir_out, malls_5000m_gpkg))
}
malls_500m <- st_read (paste0 (dir_out, malls_500m_gpkg))
malls_5000m <- st_read (paste0 (dir_out, malls_5000m_gpkg))

shop_classes <- place_types$shop %>% names
for (i in seq_along (shop_classes))
{
    vals <- place_types$shop %>% extract2 (i)
    for (j in seq_along (vals))
    {
        gpkg_name <- paste0 ("shop_", shop_classes [i], "_", vals [j], ".gpkg")
        if (!gpkg_name %in% dir (dir_out))
        {
            sh <- try (osm_to_sf (bbox = bbox_coords, crs = crs_utm_london,
                             key = "shop", value = vals [j],
                             geom_type = "osm_points"), silent = TRUE)
            if (!inherits (sh, "try-error"))
            {
                if (dim (sh) [1] > 0)
                    sh %<>% st_intersection (malls_500m)
                if (dim (sh) [1] > 0)
                {
                    sh <- st_sf (data.frame (sh$geometry,
                                             class = shop_classes [i],
                                             key = "shop",
                                             value = vals [j]))
                    st_write (sh, paste0 (dir_out, gpkg_name))
                }
            }
        }
    }
}
if (!shops_gpkg %in% dir (dir_out))
    system ("bash merge_gpkg.sh shop")

if (!public_transport_station_gpkg %in% dir (dir_out))
{
    public_transport <- osm_to_sf (bbox = bbox_coords, crs = crs_utm_london,
                                   key = "public_transport", value = "station",
                                   geom_type = "osm_points")
    st_write (public_transport$geometry,
              paste0 (dir_out, public_transport_station_gpkg))
}
if (!junctions_gpkg %in% dir (dir_out))
{
    junctions <- osm_to_sf (bbox = bbox_coords, crs = crs_utm_london,
                                   key = "highway", value = "motorway_junction",
                                   geom_type = "osm_points")
    junctions %<>% st_intersection (malls_5000m)
    st_write (junctions$geometry, paste0 (dir_out, junctions_gpkg))
}

amenity_classes <- place_types$amenity %>% names
for (i in seq_along (amenity_classes))
{
    vals <- place_types$amenity %>% extract2 (i)
    for (j in seq_along (vals))
    {
        gpkg_name <- paste0 ("amenity_", amenity_classes [i], "_", vals [j],
                             ".gpkg")
        if (!gpkg_name %in% dir (dir_out))
        {
            am <- try (osm_to_sf (bbox = bbox_coords, crs = crs_utm_london,
                             key = "amenity", value = vals [j],
                             geom_type = "osm_points"), silent = TRUE)
            if (!inherits (am, "try-error"))
            {
                if (dim (am) [1] > 0)
                    am %<>% st_intersection (malls_500m)
                if (dim (am) [1] > 0)
                {
                    am <- st_sf (data.frame (am$geometry,
                                             class = amenity_classes [i],
                                             key = "amenity",
                                             value = vals [j]))
                    st_write (am, paste0 (dir_out, gpkg_name))
                }
            }
        }
    }
}
if (!amenities_gpkg %in% dir (dir_out))
    system ("bash merge_gpkg.sh amenity")

if (!highways_gpkg %in% dir (dir_out))
{
    highways <- osm_to_sf (bbox = bbox_coords, crs = crs_utm_london,
                           geom_type = "osm_lines", key = "highway",
                           value = c ("primary", "secondary"))
    highways %<>% st_intersection (malls_5000m)
    st_write (highways$geometry, paste0 (dir_out, highways_gpkg))
}

amenities <- st_read (paste0 (dir_out, amenities_gpkg))
highways <- st_read (paste0 (dir_out, highways_gpkg))
junctions <- st_read (paste0 (dir_out, junctions_gpkg))
public_transport <- st_read (paste0 (dir_out, public_transport_station_gpkg))
shops <- st_read (paste0 (dir_out, shops_gpkg))
```

```{r results = 'asis', warnings = FALSE, message = FALSE}
occurence <- function (component, n, m)
{
    l <- length (component)
    return (l >= n && l <= m)
}

property <- function (component, prop)
{
}

correlation <- function (c1, c2, ns)
{
}

distribution <- function (component, sai)
{
}

proximity <- function (c1, c2, av)
{
}
```

```{r results = 'asis', warnings = FALSE, message = FALSE}
```
